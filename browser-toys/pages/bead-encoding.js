import { m } from '../util/lib.js'

import Page from '../components/page.js'

const beadsByLetter = new Map([['0','âšªâšªâšª'],
  ['A','âšªâšªðŸ”´'],['B','âšªâšªâš«'],['C','âšªðŸ”´âšª'],
  ['D','âšªðŸ”´ðŸ”´'],['E','âšªðŸ”´âš«'],['F','âšªâš«âšª'],
  ['G','âšªâš«ðŸ”´'],['H','âšªâš«âš«'],['I','ðŸ”´âšªâšª'],
  ['J','ðŸ”´âšªðŸ”´'],['K','ðŸ”´âšªâš«'],['L','ðŸ”´ðŸ”´âšª'],
  ['M','ðŸ”´ðŸ”´ðŸ”´'],['N','ðŸ”´ðŸ”´âš«'],['O','ðŸ”´âš«âšª'],
  ['P','ðŸ”´âš«ðŸ”´'],['Q','ðŸ”´âš«âš«'],['R','âš«âšªâšª'],
  ['S','âš«âšªðŸ”´'],['T','âš«âšªâš«'],['U','âš«ðŸ”´âšª'],
  ['V','âš«ðŸ”´ðŸ”´'],['W','âš«ðŸ”´âš«'],['X','âš«âš«âšª'],
  ['Y','âš«âš«ðŸ”´'],['Z','âš«âš«âš«']])
const valuesByNumeral = {M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1}
const morseByCharacter = new Map(Object.entries({' ':'/', 'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.',
'F':'..-.','G':'--.','H':'....','I':'..','J':'.---','K':'-.-','L':'.-..','M':'--','N':'-.','O':'---',
'P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-','U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--',
'Z':'--..','0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...',
'8':'---..','9':'----.'}))
const morseBeadByCharacter = new Map(Object.entries({'A':'â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','B':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸','C':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸','D':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸','E':'â—¼ï¸',
'F':'â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸','G':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸','H':'â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸','I':'â—¼ï¸â—»ï¸â—¼ï¸','J':'â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','K':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','L':'â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸','M':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','N':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸','O':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸',
'P':'â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸','Q':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','R':'â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸','S':'â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸','T':'â—¼ï¸â—¼ï¸','U':'â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','V':'â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','W':'â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','X':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','Y':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸',
'Z':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸','0':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','1':'â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','2':'â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','3':'â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','4':'â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸','5':'â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸','6':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸','7':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸',
'8':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—»ï¸â—¼ï¸','9':'â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸â—¼ï¸â—»ï¸â—¼ï¸'}))

function toRomanNumerals(num) {
  if (Number(num) === 0)
    return '0'
  let str = ''
  for (let numeral of Object.keys(valuesByNumeral)) {
    let repeatCount = Math.floor(num / valuesByNumeral[numeral])
    num -= repeatCount * valuesByNumeral[numeral]
    str += numeral.repeat(repeatCount)
  }
  return str
}

export default function BeadEncoding() {
  let output = ''

  function process(input) {
    if (input === '') {
      output = ''
      return
    }

    const filtered = input.toUpperCase().replaceAll(/[^A-Z0-9 ]/g, '')
    const romanized = filtered.replaceAll(/[0-9]+/g, m => toRomanNumerals(m)).replaceAll(' ', '')
    const base3Beads = ['E','0',...romanized].map(c => beadsByLetter.get(c)).join('\n')
    const morsed = Array.from(filtered).map(c => morseByCharacter.get(c)).join(' ')
    const morseBeads = filtered.split(' ').map(word => Array.from(word).map(char => morseBeadByCharacter.get(char)).join('â—»ï¸â—»ï¸')).join('â—»ï¸â—»ï¸â—»ï¸')

    output = `Filtered: ${filtered}`
    output += `\nRomanized: ${romanized}`
    output += `\nBase3 Beads (len=${romanized.length * 3 + 6}):\n${base3Beads}`
    output += `\nMorse (len=${morsed.length}):\n${morsed}`
    output += `\nMorse Beads (len=${morseBeads.length/2}):\n${morseBeads}`
  }

  return {
    view: () => m(Page, {title: 'Bead Encoding'}, [
      m('div.card', [
        m('heade', 'Input'),
        m('pre', {'data-placeholder':'Input...', contenteditable:'true', role:'textbox', oninput: e => process(e.target.textContent)})
      ]),
      m('div.card', [
        m('heade', 'Output'),
        m('pre', {'data-placeholder':'Empty...'}, output)
      ])
    ])
  }
}
